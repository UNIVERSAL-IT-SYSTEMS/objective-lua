require 'olua' 

local olua_newobjectid = olua.newobjectid

module("olua.lib", package.seeall)

local function createSubclass(superclass, name)
	local templates = {}
	
	local id = olua_newobjectid()
	local newclass =
		{
			superclass = function(class)
				return superclass
			end,
			
			name = function(class)
				return name
			end,
			
			methodTemplates = function(class)
				return templates
			end,
			
			hash = function(class)
				return id
			end
		}

	local mt =
		{
			__newindex = function(self, key, value) return [self operatorIndex: key withValue: value] end,
			__tostring = function(self) return [self toString] end
		}
		
	if superclass then
		mt.__index = superclass
	else
		mt.__index = function(self, key) return [self operatorIndex: key] end	
	end		
	setmetatable(newclass, mt)
	
	return newclass
end

-- Create the base object with enough functionality that we can start adding
-- methods to it. (We need to use rawset for this to avoid the last-ditch
-- handler kicking in.)

Object = createSubclass(nil, "Object")
rawset(Object, "createSubclassNamed_", createSubclass)

-- Add a new class method category.

rawset(Object, "addClassMethodCategory_withTemplate_",
	 function(class, category, template)
		-- We instantiate the template immediately; the methods are then added
		-- to the current class. We just ignore the category name for now.
		-- (We can't get the template to directly add the methods to the class
		-- because the newIndex handler will kick in.)
		
		local m = {}
		template(m, class:superclass(), class)
		for k, v in pairs(m) do
			rawset(class, k, v)
		end
	end
)

-- Add a new object method category.

rawset(Object, "addObjectMethodCategory_withTemplate_",
	function(class, category, template)
		-- The template gets added to the set. We'll instantiate them when the
		-- object gets instantiated.
		
		if not category then
			category = 1
		end
		
		local templates = class:methodTemplates()
		if templates[category] then
			error("Category already defined")
		end
		
		templates[category] = template
		templates[#templates+1] = template
	end
)

-- Load the rest of the class library.

require 'olua.lib.object'
require 'olua.lib.invocation'
require 'olua.lib.exception'
require 'olua.lib.proxy'
